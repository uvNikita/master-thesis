\chapter{Discussion}
\label{chap:discussion}
The main challenges of creating a classification system based on a real-world image collection learned from this research will be presented and discussed in this chapter together with analysis on how those challenges and other factors could potentially influence final classification performance of the developed system. The main limitation of this study is that all experiments were performed on the single real-world dataset. Therefore the generalizability of all results and insights is in question. While results are considered likely to be more generalizable to datasets similar to the one used in the study, the discussion also reflects on how different challenges and observation can apply to other real-world datasets. The next sections will include descriptions of other research limitations as well as how future studies can address them and expand new knowledge even further.

\section{Real-world dataset challenges}
\label{sec:real-world-dataset-challenges}

\subsection{Unique set of categories}
One of the main reasons to train neural networks on a real-world image collection instead of using standard datasets like ImageNet can be the unique nature of the problem that final system suppose to solve. A category set from the standard image database is often designed to be as general as possible since it should be suitable for wide range of applications. However, it might not be possible to solve some domain-specific tasks using such systems. The same applied to the NTB dataset employed in this research. As described in Section \ref{sec:dataset-analysis} this dataset is oriented towards Norway, sports, and politics and has its own, unique set of categories. The same challenge might arise for many other real-world datasets created for their particular purposes. A unique dataset not only gives the opportunity to solve new problems, but it also brings additional challenges connected with it. The distinct nature of the dataset implies that features particular to it have to be learned by the system and can not be found in already pre-trained models. One result from this is that multi-label classification architectures that split an image into parts and turn a multi-labeling problem into a single-labeling case might perform less efficiently. The reason for this can be that these approaches depend on having a pre-trained single-label classifier for the same set of categories, which is considered unlikely to exist due to the unique nature of a dataset. More experiments and further research can validate this hypothesis. However, fine-tuning can still be applied in the case of real-world image collection since a number of studies showed that different pictures tend to have similar low-level features in convolutional neural networks \cite{Pan2010TransferLearningSurvey, Oquab2014TransferringMidLevel}. Another study revealed that fine-tuning can be applied even in cases when the original dataset was trained on an entirely different set of categories \cite{Yosinski2014HowTransferable}. This observation suggests that classification systems built on top of real-world datasets can still leverage available pre-trained models. Results obtained in this research are also confirming this. However, since the study was limited to only one set of categories, more experiments should be conducted to check to which extent real-world datasets can utilize pre-trained models. 

\subsection{Category tree transformation}
Categories of the dataset used in this research were organized in a tree structure. It is considered likely that another real-world dataset of this kind might also have hierarchical categories definition. It was discovered that there are challenges when it comes to the transformation of this hierarchy to a flat structure used by modern neural networks. The primary objective of such change is to maximize available metadata utilization while keep or even improve the consistency of the labeling. Depending on the original category tree, a level of coherence in both relationship between categories (such as \textit{part-of} or \textit{one-of}) and the labeling rules, this process can be automatized to a particular level.

One of the key decisions that have to be made during the tree transformation is which parts of the categories tree should be included, excluded, or merged. There can be three approaches: to keep all nodes of the tree, to keep only leaves, or to use a combination of this two. On the one side, knowing the child category, it is always possible to automatically derive parent label, and therefore it should not be included as a separate category. However, in some cases, parent classes can also contain images (which was the case in the dataset used in this research), and by keeping only leaves of the tree, one can potentially remove a significant part of the metadata. To maintain consistency withing the categories, in cases when particular parent label was included in the final selection, its images should be extended with all pictures of its descendants.  For instance, category \textit{trees} should include pictures of all types of trees from the hierarchy. The issue here is to automatically find, which of the categories have subclass kind of relationship, and which not. Even if the designed hierarchy contains only subclass and superclass connections between labels, in some cases the meaning of the category should also be counted in the decision. For example, in the used dataset it was two parent classes with some descendants \textit{dogs} (with different breeds under it) and \textit{fruits} (with types of fruits as children). \textit{dogs} subtree can potentially be merged into the one category since all breeds have similar visual featured that system could use to classify images into this category. Types of fruits, on the other hand, do not have common features and therefore combining all such images can potentially decrease the precision of the end system. Desired granularity of the system can also be a factor on if the final selection should include categories from the whole subtree or only the top category with merged images as described earlier.

All described observations based on one categories tree transformations. Therefore more studies can reveal additional challenges connected with the consistency withing categories and automatization of this process. Due to many issues with a tree structure of the used dataset, it was necessary to perform the manual analysis of the hierarchy for this study. 

% One of the key decisions that have to be made during the tree transformation is which parts of the categories tree should be included, excluded, or merged. There can be three approaches: to keep all nodes of the tree, to keep only leaves, or to use combination of this two. On the one side, parent label can always be automatically derived knowing the child label and therefore should not be included as a separate category, however considering the case where parent category can also be used to label images it becomes important to make a choice between how fine-grained system will be and how much metadata can be utilized. Decision on if the particular subtree should me merged into the one category can also be automatized based on the number of images available in the top category of this subtree and a total number of images of its descendants. For instance, by setting a particular rate one can control on how big percentage of the subtree can be sacrificed in order to get desired granularity of the system. However, the ability to automatize this process depends on the categories of the particular dataset since in some cases contextual meaning of the labels is also necessary in order to make a decision. For example, in the used dataset it was two parent categories with number of descendants \textit{dogs} (with different breeds under it) and \textit{fruits} (with different types of fruits). \textit{dogs} subtree can potentially be merged into the one category since all breeds have similar visual featured that could be used by the system. Types of fruits on other hand do not have common features and therefore combining all such images can potentially decrease precision of the end system.

% However, if the categories tree would be originally designed to only define subclass relashanship between categories, it would be possible to 

% One of the factors is if only leaves of the tree or both parent and child categories can contain images and how consistent are labels when it comes to this connection. For example,

\subsection{Unsuitable categories}
The labels tree transformation also revealed challenges connected with categories not suitable for image classification system training. Around half of the NTB categories were classified as too abstract, contextual, ambiguous or combined terms. The main challenge here is that it is likely to be practically impossible currently to automatize the process of filtering categories by this criteria. One possible solution for this could be to use such system like WordNet to identify abstract terms. However, the discovery made in this research suggest that some labels might be contextual or not depending on the particular nature and context of the dataset itself. For instance, some non-contextual categories from the Norwegian image collection could potentially be considered as such in the dataset from another country. Also in some cases, a correct judgment requires the expert knowledge about particular categories. For instance, in order to classify \textit{nordic-combined} category as combined action, one should know that this sport is a combination of different types of skiing. There are two general suggestions on categories selection that can be derived from the discoveries and insights of the study:

\begin{enumerate}
    \item The category name should be straightforward, unambiguous, and clear.
    \item It should be possible to assign an image to this category only by its visual content.
\end{enumerate}

There are two main reasons for this:

\begin{enumerate}
    \item This will increase the chance that all manual labelers will agree on the meaning of the term and therefore potentially it will be better consistency in the category itself.
    \item If the end system will be used to provide a search solution for users, this can potentially help users to understand the meaning of the category and apply the filter accordingly.
\end{enumerate}

More challenges in categories selection can potentially be found in further research that involves other real-world datasets.

\subsection{Contextual images}
In addition to contextual categories which require extra information about an image for classification, results also indicated challenges connected with contextual images. Such images were assigned to a particular category not by its visual features but due to additional information available for manual labler such as an event where the picture was taken, its date and place. The problem is that modern convolutional neural networks used to build classification system can currently utilize only visual information that is available on the picture. Therefore, such images potentially can negatively impact the average precision value of the final system as well as its actual classification performance. While it is considered to be hard to remove this kind of images from the dataset fully automatically, the study suggests a method that can be used to improve existing dataset using semi-automatic approach. The method utilizes knowledge of the connections between categories as well as available dataset metadata to filter out contextual content from the particular categories. Due to time limitation of the project, this approach was tested only during the trial experiment where images labeled as \textit{portraits}, \textit{coaches} and \textit{press-conference} were removed from other categories such as \textit{football} or \textit{skiing} since, in the case of sports classification, images from these classes were considered to be contextual. For instance, in this case, it was considered that press-conference picture could not be assigned to \textit{football} category only by a visual information but also having information about the topic of this even. While this method can partially solve the issue, it still requires an in-depth knowledge of the dataset to find such connections between different categories. However, a search of such correlations can also be simplified by investigating false-negative error cases of the trained on the original dataset system. Such investigation was made on some results from the main experiment where it was discovered that significant part (34.4\%) of the false-negative pictures of \textit{automobile-racing} category were also labeled as \textit{portrait}, \textit{full-length-portrait}, \textit{spectators}, or \textit{press-conferences}. By applying this approach for other labels, it is possible to obtain new knowledge of the connections between different categories that can be further employed to improve original dataset and train model again. This method can also be applied on the next level where the trained classification system itself can be used to filter out images from the dataset based on the obtained knowledge. For instance, having a relatively good classifier of \textit{portraits} it is possible to remove even those portrait images from sports categories that were missed to be labeled as such in the original dataset by mistake. Proposed method can help to eliminate part of the contextual images automatically. However manual filtering of the pictures can potentially give even better results. More research should be done to further check the potential of the described approach.

\subsection{Background entities}
Standard single-label datasets like ImageNet contain images where the object is clearly visible and located in the center of picture \cite{Russakovsky2015ImageNet}. However such multi-label datasets as PASCAL VOC are trying to include ``real-world'' photographs where several objects placed on the image scene in different combinations \cite{Everingham2010PASCAL-VOC}. As described in Section \ref{sec:dataset-analysis}, many images in the NTB dataset contain several objects in the picture, sometimes labeled objects are small or located in the background of the photograph. The similar case can be expected for other real-world datasets, which consist of images that were not selected specifically for training. A possible solution for this problem could be to use methods that partition the image and can find an object independently of where its location \cite{Ren2016, Yang2015, Wei2016HCP}. However, as discussed earlier, it might not work for specific categories for which there is no pre-trained single-label classifier. Except for the identification of this challenge, no investigation of its influence on the final system performance was performed. Therefore, further studies should be conducted to examine its impact and to discover possible solutions for it.

\subsection{Duplicates}
The study also indicates that dataset can contain visually similar images taken from one event close to each other in time, which might also apply to the other real-world datasets. The main challenge here is to reduce a possibility of two similar pictures be assigned to different sets during the dataset split process. By applying various methods of image similarity calculation, it can be possible to reduce the number of such images. Such additional image metadata like date and place can also be incorporated in this process to reduce an amount of calculations by applying the algorithms to particular sets of pictures. Similar to the previous challenge, due to time limitations of the project, this study only indicates the possibility of such issue to accrue and do not try to address it. How this issue can influence average precision results is further discussed in the next section.

% IN general the manual work on the category tree is most likely required, but not necessarily on the image level.

\section{Classification performance}
The primary metric of the system classification performance used in the study was average precision. While this metric is widely used in the research to compare various models \cite{Everingham2010PASCAL-VOC}, the real system accuracy can be different from the calculated value. As described in Section \ref{sec:trial-testing}, the average precision level is computed based on the precision-recall curve for each label. This curve represents the possible state of the system for the category based on a particular configuration. Therefore, the final system setup can be adjusted according to specific requirements for each label to achieve desired precision-recall rate from the possible range. The average precision metric can give indications on which of the implementations more likely will give better end system accuracy than others.

Results from the study indicate a big of deep neural networks used to solve classification problems when trained on real-world datasets. While the author was expecting that categories that represent physical objects would show significantly better average precision results, experiments conducted in the study revealed that mostly sports and action categories were on the top list. Further sections discuss how different challenges and properties of the system and dataset can potentially influence final results.


% average precision is only a general metric, the actual precision-recall levell should be configured acording to user reqirenmentsin terms of precision-recall rate.

% while it was expected to get better performance for phisical-objects, but action and sports . can be connected with the size

% norw spec categories showed good performance

\subsection{Duplicates}
As discussed earlier, it was discovered that due to the real-world nature of the dataset there is a possibility to encounter similar images in different sets during dataset splitting process. This duplicated images can potentially influence both real and reported system performance. For instance, the loss value reported during the validation iterations can be influenced if validation and training sets contain copies of images. In the same way, average precision reported by the calculations can increase if test set will include images visually very similar to several pictures from the training set. This issue could potentially decrease the validity of the results regarding the generalizability of the classification system. However, as an extra validation, it is possible to perform an additional testing process on the set of images outside of the original dataset, which could decrease chances to encounter duplicate image in the test set. Due to time limitations of the project this issue was not addressed in the study, therefore more research should be conducted to investigate the number of such images and how it can effect experiments.

\subsection{Contextual images}
Results show that removing contextual images from categories can increase the mean average precision of the system. However, while most of the categories improved their precision values, some of them received worse results. Therefore, such filtering should be applied with caution. Findings also suggest that such filtering can also influence even those labels, where training sample was not changed. Such behavior can be connected with the fact that in deep neural networks last classification layer can use same subsets of features from the previous layers to determine probabilities for different categories. Therefore, by changing sample for one class, a model can learn slightly different features which then can impact other labels.  Contextual images can potentially be also the reason for systems which are training on real-world datasets be more sensitive to overfitting since neural network can start to optimize weights to this contextual images from the training set. Therefore, it can also negatively impact the generalizability of the end system. However, results also showed that in some cases trained system was able to generalize on the visually recognizable images from the category correctly, and significant part of the ``false-negative'' errors consisted of contextual images. Since such pictures in the study were removed both from the training and test set, the difference in average precision can also be influenced not only by changed weights of the network but also due to more consistent selection in the test set. Therefore, more study should be done to investigate on the level of impact of such filtering on the system performance, as well as to get insights on its nature.
% more reasearch to get insights on why
%This can potentially positively impact end performance of the final system. Such filtering should be done with caution since obtained results also suggest that it is possible to reduce performance of some categories. However, more results should be made in order to get insights on the reasons of such behavior. 
% interesting obsurvation from the result suggest, that even though such contextual images impact the numbers of average precision, but the actual system performance can still be good

\subsection{Training sample size}
Multiple results from the experiments suggest logarithmic nature of the correlation between the sample size and the final average precision of the category. This dependency might be the main reason why sports and action categories showed the best results in the experiments. However, the study also indicates that there is a broad range of average precision values for similar sample sizes. This situation can be connected with the quality of pictures of the particular category regarding consistency, diversity, and representability, as well as the different level of challenge related to the automatic classification of these categories. One possible way to improve the precision for a label with a small sample size is to extend image collection with images from the standard datasets where such category exists. However, this can also result in the loss of the class specific properties of this particular dataset. More studies with real-world datasets of different sizes should be performed to validate the findings of this research.


\subsection{Ground-truth errors}
Additional experiments on the trained system showed that due to inconsistency and errors in the original dataset the real system classification performance could be better than the one reported by the average precision metric. Investigation showed that in some cases system correctly classified pictures that were not labeled accordingly in the ground-truth set. However, to calculate the actual system performance and its difference between reported one, a manual check of or error cases required. Therefore this study can only give indications of such behavior of the system and more research should be done to validate them.

\subsection{Specialized classifier}
Another utilization of the categories hierarchy can be to build specific classifiers for particular subtrees. In this case, the end system will consist of two parts. The first part will be a high-level classifier which is trained on merged and more general categories. This first classifier will then call a specific classifier for a particular subtree of categories. A small example of such system was built during the trial set of experiments where the main classifier could recognize general \textit{skiing} pictures and then could call specific skiing classifier that can distinct between different types of skiing.  The classification precision of such system for the particular category will be defined as multiplication of the accuracy of the first classifier for the parent category and the accuracy of the specific classifier for the category itself. Such system can potentially have better end performance since each neural network will have smaller set of categories and therefore more resources can be utilized to find distinctive features of different categories. The main disadvantage of this approach would be increased complexity in terms of building, training, and usage of the system. The study did not compare these two strategies but rather showed a proof of concept of such system. Therefore further research could reveal more challenges and opportunities of this method.

\subsection{Network setup}
This section will discuss how different network configurations, architectures and implementations used in the research influenced overall system performance.

\subsubsection{Network architecture}
% DNN improvement should go together with better dataset

The study compared two convolutional neural network implementations: CaffeNet and GoogleNet. Since the latter model is newer than the former one and showed better results when trained on the ImageNet image collection \cite{Szegedy2015GoingDeeper}, the author expected to get improved average precision values on the system based on the GoogleNet. However, results indicate that the CaffeNet based system had higher mean average precision value. Results also suggest that this system worked better for categories with small sample sizes, while GoogleNet based model was better at a classification of the categories with large training sample sizes. The implementation of the system also confirmed that GoogleNet model is more resource demanding model than CaffeNet and requires more time to converge. Therefore results give an indication that investments in modern and advanced CNN architecture do not necessarily result in higher system performance. However, the study was limited only to two CNN designs. Therefore more research with different network architectures should be done to validate these observations.


\subsubsection{Solver algorithm}
Two solver algorithms were compared during the trial experiments. The Adam solver algorithm showed significantly better results than SGD during the training process. This difference can also be interpreted as that Adam solver finds a local minimum of the loss function faster than SGD. Running neural network training with both algorithms longer potentially could give similar average precision values for all categories. However, provided results suggest that in the current environment Adam solver converges in a shorter time. Other studies also show similar results \cite{adam}. While the decision on which solver method to chose should be made in each particular case, it can be argued based on the results that Adam solver can be a good first choice due to its performance characteristics.

\subsubsection{Image data source}
While image data source should not influence classification performance directly, it can impact the network training process regarding the speed and flexibility. Two approaches for the image data source were tested in the study: Python DataLayer and LMDB file. The latter method showed significantly better results in terms of the training speed by achieving the five-times difference compared to the former one. Part of the reason for such result can be explained by the fact that LMDB stores images as a decompressed and prepossessed array of bytes, while in the Python layer implementation each image was decompressed and cropped in runtime. It worth mentioning that all image processing in the LMDB case happens before the start of the training, therefore it requires an additional step in the dataset preparation stage. However, since all main experiments were performed on the same dataset of images, this prepossessing was performed only once, and the same database file was further employed. An additional downside of this approach is an extra storage space needed for the database file itself. While LMDB employed as an image data source performs faster than the Python data layer, the latter one gives more flexibility by enabling to make changes in a picture collection in runtime. Which of the approaches to choose depends on the requirement of the task. Caffe framework also supports other types of data layers including LEVELDB, HDF5 data, MemmoryData \cite{CaffeLayerCatalogue}. This research was limited to compare only two different image data sources which were suitable to a corresponding part of the study. Therefore, more studies should be conducted to analyze other supported sources from various perspectives.

\subsubsection{Dataset splitting method}
Image collections which consist of real-world pictures are considered more likely to be multi-label rather than single-label for reasons such as:
\begin{itemize}
    \item Pictures can contain several objects or people on the scene
    \item The category set can have multiple dimensions including color, size, type of object or action, and place. Therefore several labels are needed to describe a single picture in this multidimensional space of categories.
\end{itemize}

As described earlier, the multi-label case can lead to a challenge of splitting such dataset into tree parts: training, validation and test sets. Two dataset splitting methods were tested in the research: the priority method used during trial experiments, and the random method applied in main experiments. However, due to time limitations of the project they were compared only by their direct properties, the influence of the dataset splitting method on the end system classification performance was not investigated. While the random method has better properties when it comes to the small difference between a desired and average actual ratio, some studies suggest that other methods could give better mean average precision value of the classification \cite{Sechidis2011OnData}. Therefore further research can include more splitting approaches to investigate their impact on generalizability and performance of the system.
% dataset split: to draw a figure:
% 1 2 3
% 2 3 1
% the best ED doent neccearaly mean best results

% NTB dataset
% * context dependent
% * what is on label is not the center of the picture
% * missplaced labels
% * duplicates?
% * tag 'alone' modificator(?)
% * label is the main part of the image or just supplimentary?



% by using one dataset split I can introduce bias (fitting this particular split), but last networks can retrain with different random samples to check this.


% NTB dataset can be restructured and improved in the same way as IMAGENET was made.


% NTB categories were organized in the tree structure with the parent-child connection that could correspond to ``one-of'' or ``part-of'' relationships. Example: sports with football and swimming (one-of); the-body: hand, chest etc.

% (ski-jumping -> ski-flying) -- what kind of relationship?

% Some of the categories were fully contextual: persons -> men (grandfathers, fathers), women (grandmother, mothers), sometimes it is mix: children (boys, girls, sons, daughters).


% would be interesting to add IMAGENET dataset to the NTB one. This would require to merge categories trees


% norwegian specific: stave-churches, prisoners and prison cells can be not distiguashible